name: License
on:
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 12 * * *'  # Run daily

jobs:
  test:
    runs-on: ubuntu-latest
    name: Update BSL change date
    steps:
      - uses: actions/checkout@v3
        with:
          # We need a commit that modified a file other than the license
          fetch-depth: 5
      - name: Check last commit date
        run: |
          # The date of the last commit that modified a file other than the license
          commit_date=$(git log -1 --format=%cd --date=short -- . ':!/LICENSE')
          [ -z "$commit_date" ] && exit 0

          # The date in the license
          change_date=$(sed --quiet --regexp-extended 's/^Change Date:\s+([0-9]{4}-[0-9]{2}-[0-9]{2})/\1/p' < LICENSE)
          [ -z "$change_date" ] && exit 0
          
          new_change_date=$(date --date "$commit_date +3 years" --iso-8601)
          echo $commit_date
          echo $change_date
          echo $new_change_date

          if [ "$(date --date "$new_change_date" +%s)" -ge "$(date --date "$change_date" +%s)" ]; then
            sed --in-place "s/$change_date/$new_change_date/" LICENSE
            git config user.name 'Expo Bot'
            git config user.email bot@expo.dev
            git add LICENSE
            git commit -m "[license] Update BSL Change Date to $new_change_date"
            [ $(git branch --show-current) = main ] && git push
          fi
